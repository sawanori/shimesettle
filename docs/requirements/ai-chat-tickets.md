# AIチャット財務クエリ機能 チケット一覧

**プロジェクト**: ShimeSettle AIアカウンタントチャット
**作成日**: 2024-12-19
**総チケット数**: 50件

---

## 作業分担ルール

| 担当 | 説明 | 担当領域 |
|------|------|---------|
| **Claude Code (A)** | Supabase MCP接続あり | DB設定、マイグレーション、API Routes、Supabaseクエリ |
| **他AI (B)** | コード生成のみ | フロントエンドUI、型定義、ユーティリティ、テスト |

---

## Phase 1: 基盤構築

### 1.1 データベース

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-001 | chat_conversations テーブル作成 | **A** | 高 | S |
| CHAT-002 | chat_messages テーブル作成 | **A** | 高 | S |
| CHAT-003 | chat_usage テーブル作成 | **A** | 高 | S |
| CHAT-004 | RLS ポリシー設定（全テーブル） | **A** | 高 | S |
| CHAT-005 | インデックス作成 | **A** | 中 | S |
| CHAT-006 | updated_at 自動更新トリガー作成 | **A** | 中 | S |
| CHAT-007 | マイグレーションファイル作成・適用 | **A** | 高 | M |

---

### 1.2 バックエンドAPI

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-008 | POST /api/chat エンドポイント作成（スケルトン） | **A** | 高 | M |
| CHAT-009 | 認証チェック実装 | **A** | 高 | S |
| CHAT-010 | レート制限実装 | **A** | 高 | M |
| CHAT-011 | リクエストバリデーション（Zod スキーマ） | **B** | 高 | S |
| CHAT-012 | エラーハンドリング共通化 | **B** | 中 | M |
| CHAT-013 | GET /api/chat/history エンドポイント作成 | **A** | 中 | M |
| CHAT-014 | DELETE /api/chat/history エンドポイント作成 | **A** | 低 | S |
| CHAT-015 | GET /api/chat/suggestions エンドポイント作成 | **B** | 低 | S |

---

### 1.3 型定義・スキーマ

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-016 | QueryIntent 型定義 | **B** | 高 | S |
| CHAT-017 | ChatRequest / ChatResponse 型定義 | **B** | 高 | S |
| CHAT-018 | QueryResult 型定義 | **B** | 高 | S |
| CHAT-019 | ChatError 型・定数定義 | **B** | 中 | S |

---

### 1.4 意図解析（Intent Classification）

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-020 | 意図解析プロンプト作成 | **B** | 高 | L |
| CHAT-021 | 意図解析モジュール実装 | **A** | 高 | L |
| CHAT-022 | 時間表現パーサー実装 | **B** | 高 | M |
| CHAT-023 | プロンプトインジェクション対策 | **B** | 高 | M |
| CHAT-024 | 意図解析ユニットテスト | **B** | 中 | M |

---

### 1.5 データ取得層（Query Builder）

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-025 | FinancialQueryBuilder クラス作成 | **A** | 高 | M |
| CHAT-026 | 日付範囲計算ユーティリティ | **B** | 高 | M |
| CHAT-027 | expense_summary クエリ実装 | **A** | 高 | M |
| CHAT-028 | expense_by_category クエリ実装 | **A** | 高 | M |
| CHAT-029 | expense_by_department クエリ実装 | **A** | 中 | S |
| CHAT-030 | sales_summary クエリ実装 | **A** | 高 | M |
| CHAT-031 | sales_by_channel クエリ実装 | **A** | 中 | M |
| CHAT-032 | sales_unpaid クエリ実装 | **A** | 高 | S |
| CHAT-033 | bank_balance クエリ実装 | **A** | 中 | M |
| CHAT-034 | profit_loss クエリ実装 | **A** | 中 | L |
| CHAT-035 | comparison クエリ実装（期間比較） | **A** | 低 | L |
| CHAT-036 | QueryBuilder ユニットテスト | **B** | 中 | L |

---

### 1.6 回答生成

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-037 | 回答生成プロンプト作成 | **B** | 高 | M |
| CHAT-038 | 回答生成モジュール実装 | **A** | 高 | M |
| CHAT-039 | 金額フォーマットユーティリティ | **B** | 中 | S |
| CHAT-040 | 会話履歴保存処理 | **A** | 高 | M |

---

## Phase 2: フロントエンド

### 2.1 コンポーネント作成

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-041 | ChatWidget コンポーネント（開閉制御） | **B** | 高 | M |
| CHAT-042 | ChatContainer コンポーネント | **B** | 高 | M |
| CHAT-043 | ChatHeader コンポーネント | **B** | 中 | S |
| CHAT-044 | ChatMessages コンポーネント | **B** | 高 | M |
| CHAT-045 | ChatMessage コンポーネント（AI/User） | **B** | 高 | M |
| CHAT-046 | ChatInput コンポーネント（IME対応） | **B** | 高 | M |
| CHAT-047 | ChatSuggestions コンポーネント | **B** | 中 | S |
| CHAT-048 | DataTable コンポーネント（表形式表示） | **B** | 中 | M |

---

### 2.2 状態管理・API連携

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-049 | useChatMessages カスタムフック | **B** | 高 | M |
| CHAT-050 | チャット状態の永続化（localStorage） | **B** | 低 | S |

---

## Phase 3: 統合・テスト

| チケットID | タイトル | 担当 | 優先度 | 見積 |
|-----------|---------|------|-------|------|
| CHAT-051 | レイアウトへの ChatWidget 組み込み | **A** | 高 | S |
| CHAT-052 | E2E テスト作成（Playwright） | **B** | 中 | L |
| CHAT-053 | パフォーマンス計測・最適化 | **B** | 中 | M |

---

## 担当別サマリー

### Claude Code (A) - 24件

| カテゴリ | チケット |
|---------|---------|
| **データベース** | CHAT-001〜007 (7件) |
| **API Routes** | CHAT-008〜010, 013, 014 (5件) |
| **意図解析** | CHAT-021 (1件) |
| **クエリビルダー** | CHAT-025, 027〜035 (10件) |
| **回答生成** | CHAT-038, 040 (2件) |
| **統合** | CHAT-051 (1件) |

**主な作業内容**:
- Supabase テーブル作成・RLS設定
- API エンドポイント実装（認証・レート制限含む）
- データベースクエリ（経費・売上・銀行）
- OpenAI API 呼び出し（意図解析・回答生成）

---

### 他AI (B) - 26件

| カテゴリ | チケット |
|---------|---------|
| **API補助** | CHAT-011, 012, 015 (3件) |
| **型定義** | CHAT-016〜019 (4件) |
| **意図解析補助** | CHAT-020, 022〜024 (4件) |
| **クエリ補助** | CHAT-026, 036 (2件) |
| **回答生成補助** | CHAT-037, 039 (2件) |
| **フロントエンド** | CHAT-041〜050 (10件) |
| **テスト** | CHAT-052, 053 (2件) |

**主な作業内容**:
- TypeScript 型定義・Zodスキーマ
- プロンプト文作成
- ユーティリティ関数
- React コンポーネント（ChatWidget, Messages, Input など）
- カスタムフック
- テスト作成

---

## 並行作業フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                         Week 1                                  │
├─────────────────────────────────────────────────────────────────┤
│  Claude Code (A)              │  他AI (B)                       │
│  ─────────────────────────    │  ─────────────────────────      │
│  CHAT-001〜007 (DB作成)       │  CHAT-016〜019 (型定義)          │
│  CHAT-008〜010 (API基盤)      │  CHAT-011, 012 (バリデーション)   │
│                               │  CHAT-020, 022, 023 (プロンプト) │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                         Week 2                                  │
├─────────────────────────────────────────────────────────────────┤
│  Claude Code (A)              │  他AI (B)                       │
│  ─────────────────────────    │  ─────────────────────────      │
│  CHAT-021 (意図解析実装)       │  CHAT-026 (日付ユーティリティ)   │
│  CHAT-025 (QueryBuilder)      │  CHAT-037 (回答プロンプト)       │
│  CHAT-027〜030 (経費・売上)    │  CHAT-039 (金額フォーマット)     │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                         Week 3                                  │
├─────────────────────────────────────────────────────────────────┤
│  Claude Code (A)              │  他AI (B)                       │
│  ─────────────────────────    │  ─────────────────────────      │
│  CHAT-031〜035 (追加クエリ)    │  CHAT-041〜044 (UIコンポーネント) │
│  CHAT-038, 040 (回答生成)     │  CHAT-045〜046 (Message, Input)  │
│  CHAT-013, 014 (履歴API)      │  CHAT-047, 048 (Suggestions等)  │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                         Week 4                                  │
├─────────────────────────────────────────────────────────────────┤
│  Claude Code (A)              │  他AI (B)                       │
│  ─────────────────────────    │  ─────────────────────────      │
│  CHAT-051 (レイアウト組込)     │  CHAT-049, 050 (フック・永続化)  │
│  動作確認・デバッグ            │  CHAT-052, 053 (E2E・最適化)     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 受け渡しポイント

### A → B への受け渡し

| タイミング | 内容 | 形式 |
|-----------|------|------|
| Week 1 完了後 | DB スキーマ情報 | types/supabase.ts 更新 |
| Week 2 完了後 | API エンドポイント仕様 | OpenAPI/型定義 |
| Week 3 完了後 | QueryResult サンプル | JSON サンプル |

### B → A への受け渡し

| タイミング | 内容 | 形式 |
|-----------|------|------|
| Week 1 完了後 | 型定義ファイル | lib/chat/types.ts |
| Week 1 完了後 | プロンプトファイル | lib/chat/prompts.ts |
| Week 2 完了後 | ユーティリティ関数 | lib/chat/utils.ts |

---

## ファイル構成（予定）

```
lib/
  chat/
    types.ts          # B: 型定義
    prompts.ts        # B: プロンプト
    schemas.ts        # B: Zodスキーマ
    errors.ts         # B: エラー定義
    utils.ts          # B: ユーティリティ
    intentClassifier.ts    # A: 意図解析
    queryBuilder.ts        # A: クエリビルダー
    responseGenerator.ts   # A: 回答生成

app/
  api/
    chat/
      route.ts        # A: POST /api/chat
      history/
        route.ts      # A: GET/DELETE /api/chat/history
      suggestions/
        route.ts      # B: GET /api/chat/suggestions

components/
  chat/
    ChatWidget.tsx      # B
    ChatContainer.tsx   # B
    ChatHeader.tsx      # B
    ChatMessages.tsx    # B
    ChatMessage.tsx     # B
    ChatInput.tsx       # B
    ChatSuggestions.tsx # B
    DataTable.tsx       # B

hooks/
  useChatMessages.ts    # B
```

---

## 作業量バランス

| 担当 | チケット数 | 見積合計 |
|------|-----------|---------|
| Claude Code (A) | 24件 | S×8 + M×12 + L×4 = **80時間相当** |
| 他AI (B) | 26件 | S×10 + M×13 + L×3 = **78時間相当** |

**バランス**: ほぼ均等（A: 50.6%, B: 49.4%）
